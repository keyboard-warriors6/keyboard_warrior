{% extends 'base_profile.html' %}
{% load static %}
{% load humanize %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/profile.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock head %}

{% block content %}
  <!-- í”„ë¡œí•„ -->
  <div id='sec1' class="title-container">
    <p class="text-4xl">í”„ë¡œí•„</p>
  </div>

  <div class="profile-container">
    <div class="flex flex-row">
      <div class="profile-image m-10">
        {% if user.profile_img %}
          <img src="{{ user.profile_img.url }}" alt="profile_img">
        {% else %}
          <img src="https://i.pinimg.com/564x/d2/98/4e/d2984ec4b65a8568eab3dc2b640fc58e.jpg" alt="no_image">
        {% endif %}
      </div>
      <div class="mt-14">
        <p class="user-name">
            {% if user.level.grade == 'B' %}
              ğŸ¥‰
            {% elif user.level.grade == 'S' %}
              ğŸ¥ˆ
            {% elif user.level.grade == 'G' %}
              ğŸ¥‡
            {% else %}
              ğŸ’
            {% endif %}
          </span>
          {{ user }}
          <span>
        </p>
        <div class="flex items-end gap-4">
          <a href="{% url 'accounts:update' user.username %}">
            <button class="button-setting mt-10">
              <p class="text-base">ì„¤ì •</p>
            </button>
          </a>
          <a href="{% url 'accounts:logout' %}">
            <button class="button-setting-big logout-button mt-10">
              <p class="text-sm">ë¡œê·¸ì•„ì›ƒ</p>
            </button>
          </a>
        </div>
      </div>
    </div>

    <hr class="profile-line">

    <div class="flex flex-row justify-around">
      <div class="text-center m-5">
        <img src="/static/img/icon_bookmark.png" alt="icon_bookmark" class="profile-icon">
        <p>ìŠ¤í¬ë©ë¶</p>
        {% comment %} <p>0</p> {% endcomment %}
      </div>
      <div class="text-center m-5">
        <img src="/static/img/icon_heart.png" alt="icon_heart" class="profile-icon">
        <p>ë¦¬ë·°ìŠ¤í¬ë©</p>
        {% comment %} <p>0</p> {% endcomment %}
      </div>      <div class="text-center m-5">
        <img src="/static/img/icon_coupon.png" alt="icon_coupon" class="profile-icon">
        <p>ì¿ í°</p>
        {% comment %} <p>0</p> {% endcomment %}
      </div>
    </div>
    <section id="example-1">
  </div>
  

  <!-- ë‚˜ì˜ ì‡¼í•‘ -->
  <div id='sec2' class="title-container mt-36">
    <p class="text-4xl">ë‚˜ì˜ ì‡¼í•‘<span class='ms-3 me-1 text-[#99ccff]'></p>
  </div>
  {% if purchases.items %}
    <!-- ì¡°íšŒ ê²°ê³¼ê°€ 1ê±´ì´ë¼ë„ ìˆì„ ë•Œ -->
    <div class="purchased_item-container">
      <button id="dropdownDefaultButton" data-dropdown-toggle="dropdown" class="text-white bg-[#99ccff] hover:bg-[#409fff] font-medium rounded-lg text-sm px-4 py-2.5 m-10 text-center inline-flex items-center" type="button">ì¡°íšŒ ê¸°ê°„<svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
      <!-- Dropdown menu -->
      <div id="dropdown" class="z-10 hidden bg-white divide-y rounded-lg shadow w-44">
        <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
          <li>
            <a href="{% url 'accounts:profile' username=user.username %}?sort=1hour" class="block px-4 py-2 hover:bg-[#99ccff]">1ê°œì›” ì „</a>
          </li>
          <li>
            <a href="{% url 'accounts:profile' username=user.username %}?sort=12hour" class="block px-4 py-2 hover:bg-[#99ccff]">3ê°œì›” ì „</a>
          </li>
          <li>
            <a href="{% url 'accounts:profile' username=user.username %}?sort=12hour" class="block px-4 py-2 hover:bg-[#99ccff]">6ê°œì›” ì „</a>
          </li>
          <li>
            <a href="{% url 'accounts:profile' username=user.username %}?sort=1hour" class="block px-4 py-2 hover:bg-[#99ccff]">1ë…„ ì „</a>
          </li>
          <li>
            <a href="{% url 'accounts:profile' username=user.username %}?sort=1hour" class="block px-4 py-2 hover:bg-[#99ccff]">2ë…„ ì „</a>
          </li>
          <li>
            <a href="{% url 'accounts:profile' username=user.username %}?sort=1hour" class="block px-4 py-2 hover:bg-[#99ccff]">3ë…„ ì „</a>
          </li>
        </ul>
      </div>

      <br>
      {% for date, purchases in purchases.items %}
        <p class="text-xl ms-5 p-3">{{ date|date:'Y-m-d' }}</p>
        <hr class="purchase-line">
        
        {% for purchase in purchases %}
          <p class="text-xl ms-10 mt-5 "><span class="text-[#99ccff]">êµ¬ë§¤í™•ì • {{ purchase.purchase_date|date:"nì›” jì¼" }}</span> - ë„ì°©ì™„ë£Œ</p>
          <div class="flex flex-row">
            <div class="purchased_item-image m-10">
              <img src="/static/img/products_sample.png" alt="icon_profile">
            </div>

            <div class="mt-10" style="width: 15rem;">
              <p class="text-sm mb-1">{{ purchase.products.first.category.brand }}</p>
              <p class="text-lg mb-1">{{ purchase.products.first.name }}</p>
            </div>

            <div class="ms-24 mt-10" style="width: 15rem;">
              <p class="text-xl mb-1">{{ purchase.products.first.discounted_price|intcomma }}ì›</p>          
              {% for purchase_item in purchase.purchaseitem_set.all %}
                <p class="text-base mb-5">ìˆ˜ëŸ‰: {{ purchase_item.cnt }}ê°œ</p> 

                <p class="text-xl mb-1">ì´ ê°€ê²©: {{ purchase_item.price|intcomma }}ì›</p>          
  
              {% endfor %}

              <p class="text-sm text-[#99ccff]">ì¼ë°˜íƒë°°</p>
            </div>

            <div class="ms-10 flex flex-column">
              <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="/products/{{ purchase.products.first.pk }}/#example-4">
                <button class="button-big button-color-delivery mt-5">
                  <p class="text-base">ìƒí’ˆ ë¬¸ì˜</p>
                </button>
              </a>
              <a data-te-nav-link-ref class="bg-transparent px-[5px]  font-semibold text-neutral-600 shadow-none" href="/products/{{ purchase.products.first.pk }}">
                <button class="button-big button-color-review mt-8">
                  <p class="text-base">ë¦¬ë·° ì‘ì„±</p>
                </button>
              </a>
            </div>
          </div>
        {% endfor %}  
      {% endfor %}
      <section id="example-2">
    </div>

    {% else %}
    <!-- ì¡°íšŒ ê²°ê³¼ ì—†ì„ ë•Œ -->
    <div class="purchased_item-container">
      <button id="dropdownDefaultButton" data-dropdown-toggle="dropdown" class="text-white bg-[#99ccff] hover:bg-[#409fff] font-medium rounded-lg text-sm px-4 py-2.5 m-10 text-center inline-flex items-center" type="button">ì¡°íšŒ ê¸°ê°„<svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
      <!-- Dropdown menu -->
      <div id="dropdown" class="z-10 hidden bg-white divide-y rounded-lg shadow w-44">
        <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
          <li>
            <a href="#" class="block px-4 py-2 hover:bg-[#99ccff]">1ê°œì›” ì „</a>
          </li>
          <li>
            <a href="#" class="block px-4 py-2 hover:bg-[#99ccff]">3ê°œì›” ì „</a>
          </li>
          <li>
            <a href="#" class="block px-4 py-2 hover:bg-[#99ccff]">6ê°œì›” ì „</a>
          </li>
          <li>
            <a href="#" class="block px-4 py-2 hover:bg-[#99ccff]">1ë…„ ì „</a>
          </li>
          <li>
            <a href="#" class="block px-4 py-2 hover:bg-[#99ccff]">2ë…„ ì „</a>
          </li>
          <li>
            <a href="#" class="block px-4 py-2 hover:bg-[#99ccff]">3ë…„ ì „</a>
          </li>
        </ul>
      </div>
      <p class='text-xl text-center mb-20'>ì£¼ë¬¸í•˜ì‹  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  {% endif %}



  <!-- ë‚˜ì˜ ë¦¬ë·° -->
  <div id='sec3' class="title-container mt-36">
    <p class="text-4xl">ë‚˜ì˜ ë¦¬ë·°</p>
  </div>


  {% if review_list %}
    <!-- ì¡°íšŒ ê²°ê³¼ê°€ 1ê±´ì´ë¼ë„ ìˆì„ ë•Œ -->
    <div class="purchased_item-container">
      <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="?sort=rating">
        <button class="button-middle button-color-delivery ms-10 mt-10">
          <p>ë³„ì ìˆœ</p>
        </button>
      </a>
      <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="?sort=created_at">
        <button class="button-middle button-color-delivery ms-3 mt-10">
          <p>ìµœì‹ ìˆœ</p>
        </button>
      </a>

      {% for review in review_list %}
        <div class="flex flex-row">
          <div class="my-10 ms-10 me-20">
            <p class="text-xl mb-2">[{{ review.product.category.brand }}] {{ review.product.name }} </p>
            <div class='flex'>
              <p class="mb-3 me-3 stars" data-raing={{ review.rating }}>{{ review.rating }}</p>
              <p class="text-base mb-3"> {{ review.created_at|date:'Y.m.d' }}</p>       
            </div>
            {% for image in review.images.all %}
              <img src="{{ image.img.url }}"  alt="ë¦¬ë·° ì‚¬ì§„" style="width:112px; height:112px; margin-top:10px; object-fit: cover;" class='mb-5'>
            {% endfor %}
            <p class="text-lg mb-2 "> {{ review.content }} </p>
          </div>
          <div class="ms-auto me-12 flex justify-center items-center">
            <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="/products/{{ review.product.pk }}">
              <button class="button-big button-color-review mt-8">
                <p class="text-base">ë¦¬ë·° ë³´ëŸ¬ê°€ê¸°</p>
              </button>
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="purchased_item-container">
      <button class="button-middle button-color-delivery ms-10 my-10">
        <p>ë² ìŠ¤íŠ¸</p>
      </button>
      <button class="button-middle button-color-delivery ms-3 my-10">
        <p>ìµœì‹ ìˆœ</p>
      </button>
      <p class='text-xl text-center mb-20'>ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì‹  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  {% endif %}
  <section id="example-3">


  
  <!-- ë‚˜ì˜ ë¬¸ì˜ -->
  <div id='sec4' class="title-container mt-36">
    <p class="text-4xl">ë‚˜ì˜ ë¬¸ì˜</p>
  </div>

  <!-- ì¡°íšŒ ê²°ê³¼ê°€ 1ê±´ì´ë¼ë„ ìˆì„ ë•Œ -->
  <div class="purchased_item-container mb-36">
    <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="{% url 'accounts:profile' username=user.username %}?sort=all">
      <button class="button-middle button-color-delivery ms-10 mt-10">
        <p>ì „ì²´ ë³´ê¸°</p>
      </button>
    </a>
    <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="{% url 'accounts:profile' username=user.username %}?sort=answer">
      <button class="button-middle button-color-delivery ms-3 mt-10">
        <p>ë‹µë³€ ì™„ë£Œ</p>
      </button>
    </a>
    {% if inquiries %}
      {% for inquiry in inquiries %}
        <div class="flex flex-row">
          <div class="my-10 ms-10 me-20">
            <p class="text-xl mb-2">[{{ inquiry.product.category.brand }}] {{ inquiry.product.name }} </p>
            <p class="text-sm mb-5"> {{ inquiry.created_at }}</p>

            <div class="mb-2.5">
              <p class='mb-5'><span class="product-inquiry-qa">Q &nbsp;</span>{{ inquiry.content }}</p>
            </div>
            
            {% if inquiry.answer %}
              <div class="mb-2.5">
                <p class='mb-5'><span class="product-inquiry-qa">A &nbsp;</span><span style="font-weight: 700; color: #424242; font-size: 15px;">ì£¼ì‹íšŒì‚¬ ì¸ìŠ¤í† ì–´ &nbsp;</span><span style="font-size: 12px; color: #bdbdbd;">{{ inquiry.answer.created_at }}</span></p>
                <p>{{ inquiry.answer.content }}</p>
              </div>
            {% endif %}
      
          </div>
          
          <div class="ms-auto me-12 flex justify-center items-center">
            <a data-te-nav-link-ref class="bg-transparent px-[5px] font-semibold text-neutral-600 shadow-none" href="/products/{{ inquiry.product.pk }}/#example-4">
              <button class="button-big button-color-review">
                <p class="text-base">ë‹µë³€ ë³´ëŸ¬ê°€ê¸°</p>
              </button>
            </a>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class='text-xl text-center my-20'>ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>
{% endblock content %}


{% block script %}
<script type="text/javascript" src="/static/JS/profile.js"></script>
<script>
  const starsEl = document.querySelectorAll(".stars");
  starsEl.forEach((stars) => {
    const numStars = Number(stars.textContent); // ì¶œë ¥í•  ë³„ì  ê°œìˆ˜
    stars.textContent = ''
    const star = '<svg fill="#99CCFF" width=".8em" height=".8em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><defs><path id="star-path-31" d="M11.9996 19.7201L6.32294 22.1251C5.5626 22.4472 5.005 22.0311 5.0755 21.2188L5.60855 15.0767L1.5671 10.421C1.02579 9.79745 1.24924 9.13855 2.04358 8.95458L8.04973 7.56354L11.2287 2.28121C11.6545 1.57369 12.3502 1.5826 12.7706 2.28121L15.9496 7.56354L21.9557 8.95458C22.7602 9.1409 22.9667 9.8053 22.4322 10.421L18.3907 15.0767L18.9238 21.2188C18.9952 22.0414 18.4271 22.4432 17.6764 22.1251L11.9996 19.7201Z"></path><clipPath id="star-clip-31"><rect x="0" y="0" width="24" height="24"></rect></clipPath></defs><use xlink:href="#star-path-31" fill="#DBDBDB"></use><use clip-path="url(#star-clip-31)" xlink:href="#star-path-31"></use></svg>'
    for (let i = 0; i < numStars; i++) {
      stars.innerHTML += star;
    }
    stars.classList.add('flex', 'items-center')
  })
</script>
{% endblock script %}